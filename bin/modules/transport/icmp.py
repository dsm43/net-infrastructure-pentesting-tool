from scapy.layers.inet import ICMP, IP
from scapy.layers.l2 import Ether, Dot3
from scapy.all import get_if_addr, sr1, srp1
from scapy.packet import Packet, Raw
from libs.aux_funcs import type_wrapper,attack_cat,attack_layer,attack_type

@type_wrapper(name="ICMP Flood", type=attack_type.DoS, category=attack_cat.Attack, layer=attack_layer.L4, arg_list=[])
def icmp_flood(args):
    return ICMP()

@type_wrapper(name="Ping test", type=attack_type.Test, category=attack_cat.Attack, layer=attack_layer.L4, arg_list=['dest_ip'])
def icmp_test(args):
    iface=args["iface"]
    dst_ip = args["dest_ip"]
    pkt = args['pkt']

    if pkt != None:
        if pkt.haslayer(IP):
            pkt = pkt/ICMP()/Raw(b'A'*3)
        else:
            pkt = pkt/IP(dst = dst_ip, src=get_if_addr(iface))/ICMP()/Raw(b'A'*3)
    else:
        pkt = IP(dst=dst_ip, src=get_if_addr(iface))/ICMP()/Raw(b'A'*3)
    

    if pkt.haslayer(Ether) or pkt.haslayer(Dot3):
        rsp = srp1(pkt, iface=iface)
    else:
        rsp = sr1(pkt, iface=iface)
    if rsp != None:
        print("ICMP Response received")
    else:
        print("No ICMP Response")